<!DOCTYPE html>
<html>
<head>
	<title>Attendance System</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
		}
		.container {
			max-width: 800px;
			margin: auto;
			padding: 20px;
		}
		h1 {
			text-align: center;
		}
		form {
			display: flex;
			flex-direction: column;
			align-items: center;
			margin-bottom: 20px;
		}
		label {
			margin-bottom: 10px;
			font-weight: bold;
		}
		input[type="text"] {
			padding: 8px;
			border-radius: 4px;
			border: 1px solid #ccc;
			margin-bottom: 10px;
			width: 100%;
			box-sizing: border-box;
		}
		#qr-scanner {
			width: 100%;
			height: 400px;
			margin-bottom: 20px;
			border: 1px solid #ccc;
			position: relative;
		}
		#qr-scanner video {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}
		#qr-scanner canvas {
			display: none;
		}
		#qr-code {
			display: none;
		}
		table {
			border-collapse: collapse;
			width: 100%;
		}
		th, td {
			padding: 8px;
			text-align: left;
			border-bottom: 1px solid #ddd;
		}
		tr:hover {
			background-color: #f5f5f5;
		}
	</style>
</head>
<body>
	<div class="container">
		<h1>Attendance System</h1>
		<form>
			<label for="teacher-name">Teacher Name:</label>
			<input type="text" id="teacher-name" required>

			<label for="qr-scanner">Scan QR Code:</label>
			<div id="qr-scanner"></div>

			<input type="text" id="qr-code" readonly>

			<button type="button" id="start-attendance">Start Attendance</button>
		</form>

		<div id="table-container">
			<h2>Attendance Table</h2>
			<table>
				<thead>
					<tr>
						<th>Teacher Name</th>
						<th>Registration Number</th>
						<th>Enter Time</th>
						<th>Leave Time</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
	</div>

	<script src="https://unpkg.com/quagga"></script>
	<script>
		const teacherNameInput = document.getElementById('teacher-name');
		const qrScanner = document.getElementById('qr-scanner');
		const qrCodeInput = document.getElementById('qr-code');
		const startAttendanceButton = document.getElementById('start-attendance');
		const tableBody = document.querySelector('tbody');
		let currentStudent = null;

		startAttendanceButton.addEventListener('click', () => {
			if (teacherNameInput.checkValidity()) {
				qrCodeInput.value = '';
				currentStudent = null;
				tableBody.innerHTML = '';
				document.getElementById('table-container').style.display = 'none';
				qrScanner.style.display = 'block';
				qrCodeInput.style.display = 'none';

				Quagga.init({
					inputStream: {
						type: 'LiveStream',
						constraints: {
							width: 640,
							height: 480,
							facingMode: 'environment' // or 'user' for front camera
						}
					},
					locator: {
						patchSize: 'medium',
						halfSample: true
					},
					numOfWorkers: navigator.hardwareConcurrency || 4,
					frequency: 10,
					decoder: {
						readers: [
							{ format: 'ean_reader', config: {} }
						]
					},
					debug: {
						drawBoundingBox: true,
						showFrequency: false,
						drawScanline: true,
						showPattern: false
					},
					locate: true
				}, (err) => {
					if (err) {
						alert('Failed to initialize QR scanner: ' + err.message);
						qrScanner.style.display = 'none';
						qrCodeInput.style.display = 'block';
						qrCodeInput.removeAttribute('readonly');
						qrCodeInput.focus();
					} else {
						Quagga.start();
						qrCodeInput.setAttribute('readonly', '');
						qrCodeInput.focus();
					}
				});

				qrCodeInput.addEventListener('change', handleQRCode);
			}
		});

		function handleQRCode(event) {
			const qrCodeValue = event.target.value;
			if (qrCodeValue.trim().length > 0) {
				qrCodeInput.setAttribute('readonly', '');
				qrCodeInput.removeEventListener('change', handleQRCode);

				if (currentStudent === null) {
					const enterTime = new Date().toLocaleTimeString();
					currentStudent = { registrationNumber: qrCodeValue, enterTime };
					qrScanner.style.display = 'block';
					qrCodeInput.style.display = 'none';
					qrCodeInput.value = '';
					qrCodeInput.removeAttribute('readonly');
					qrCodeInput.focus();
				} else {
					const leaveTime = new Date().toLocaleTimeString();
					const row = document.createElement('tr');
					row.innerHTML = `
						<td>${teacherNameInput.value}</td>
						<td>${currentStudent.registrationNumber}</td>
						<td>${currentStudent.enterTime}</td>
						<td>${leaveTime}</td>
					`;
					tableBody.appendChild(row);
					currentStudent = null;
					qrScanner.style.display = 'block';
					qrCodeInput.style.display = 'none';
					qrCodeInput.value = '';
					qrCodeInput.removeAttribute('readonly');
					qrCodeInput.focus();
				}

				document.getElementById('table-container').style.display = 'block';
			}
		}

		Quagga.onDetected((result) => {
			const qrCodeValue = result.codeResult.code;
			if (currentStudent === null) {
				const enterTime = new Date().toLocaleTimeString();
				currentStudent = { registrationNumber: qrCodeValue, enterTime };
				qrScanner.style.display = 'none';
				qrCodeInput.style.display = 'block';
				qrCodeInput.value = qrCodeValue;
				qrCodeInput.removeAttribute('readonly');
				Quagga.stop();
			} else {
				const leaveTime = new Date().toLocaleTimeString();
				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${teacherNameInput.value}</td>
					<td>${currentStudent.registrationNumber}</td>
					<td>${currentStudent.enterTime}</td>
					<td>${leaveTime}</td>
				`;
				tableBody.appendChild(row);
				currentStudent = null;
				qrScanner.style.display = 'block';
				qrCodeInput.style.display = 'none';
				qrCodeInput.value = '';
				qrCodeInput.removeAttribute('readonly');
				Quagga.stop();
			}

			document.getElementById('table-container').style.display = 'block';
		});
	</script>
</body>
</html>
